<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Recursos - I.M.S.A.</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap">
    <style>
        :root {
            --color-produciendo: #4ade80;
            --color-detenido: #f87171;
            --color-mantenimiento: #60a5fa;
            --color-falta-personal: #f1f5f9;
            --color-falta-materiales: #fb923c;
            --color-sin-operario: #f1f5f9;
            --color-set-up: #fef08a;
            --color-primary: #ff6b6b;
            --color-text: #1e293b;
            --color-background: #f8fafc;
            --color-card: #ffffff;
            --color-border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--color-primary);
        }

        .logo-title {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .title h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            color: #334155;
        }

        .title h2 {
            font-size: 18px;
            font-weight: 500;
            margin: 5px 0 0;
            color: #64748b;
        }

        .date-time {
            background-color: var(--color-card);
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .top-content {
            display: flex;
            gap: 20px;
        }

        .left-panel {
            flex: 0 0 250px;
        }

        .right-panel {
            flex: 1;
        }

        .bottom-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .section {
            background-color: var(--color-card);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-border);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #334155;
        }

        .section-date {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .resource-box {
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 140px;
            display: flex;
            flex-direction: column;
        }

        .resource-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .resource-number {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .resource-product {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
            line-height: 1.3;
            height: 32px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .resource-time {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
            padding: 3px 6px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            color: rgba(0, 0, 0, 0.8);
            display: inline-block;
            width: fit-content;
        }

        .resource-info {
            font-size: 12px;
            margin-top: auto;
        }

        .resource-op {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 12px;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.5);
        }

        .resource-operator {
            position: absolute;
            bottom: 12px;
            right: 12px;
            font-size: 11px;
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .status-produciendo {
            background-color: var(--color-produciendo);
            color: #065f46;
        }

        .status-detenido {
            background-color: var(--color-detenido);
            color: #7f1d1d;
        }

        .status-mantenimiento {
            background-color: var(--color-mantenimiento);
            color: #1e3a8a;
        }

        .status-falta-personal {
            background-color: var(--color-falta-personal);
            color: #475569;
        }

        .status-falta-materiales {
            background-color: var(--color-falta-materiales);
            color: #7c2d12;
        }

        .status-sin-operario {
            background-color: var(--color-sin-operario);
            color: #475569;
        }

        .status-set-up {
            background-color: var(--color-set-up);
            color: #854d0e;
        }

        .legend {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .legend-item:last-child {
            border-bottom: none;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .legend-text {
            font-size: 14px;
        }

        .legend-text strong {
            display: block;
            font-weight: 600;
            margin-bottom: 3px;
        }

        @media (max-width: 1100px) {
            .top-content {
                flex-direction: column;
            }
            
            .left-panel {
                flex: 0 0 100%;
            }

            .legend {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .bottom-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .date-time {
                align-self: stretch;
                align-items: flex-start;
            }
            
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        .logo img {
        max-width: 100px;
        height: auto;
        }

        .loading-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            font-size: 16px;
            color: #64748b;
        }

        .error-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #991b1b;
            font-size: 16px;
        }

        .connection-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .connection-status.online {
            background-color: #dcfce7;
            color: #166534;
        }

        .connection-status.offline {
            background-color: #fee2e2;
            color: #991b1b;
        }

        /* Estilos para pesta√±as */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs-header {
            display: flex;
            background-color: var(--color-card);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button:hover {
            background-color: #f1f5f9;
            color: #334155;
        }

        .tab-button.active {
            background-color: var(--color-primary);
            color: white;
        }

        .tab-content {
            display: none;
            background-color: var(--color-card);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .section-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-item {
            background-color: #f8fafc;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .stat-item.produciendo {
            background-color: #dcfce7;
            color: #166534;
        }

        .stat-item.detenido {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .stat-item.mantenimiento {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .stat-item.otros {
            background-color: #f3f4f6;
            color: #374151;
        }

                 /* Estilos para m√©tricas */
         .metrics-container {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .metric-card {
             background-color: #f8fafc;
             border-radius: 8px;
             padding: 15px;
             border-left: 4px solid var(--color-primary);
         }

         .metric-title {
             font-size: 14px;
             font-weight: 600;
             color: #334155;
             margin-bottom: 8px;
         }

         .metric-subtitle {
             font-size: 12px;
             color: #64748b;
             margin-bottom: 10px;
             font-style: italic;
         }

         .metric-sections {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }

         .metric-section {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 6px 0;
             border-bottom: 1px solid #e2e8f0;
         }

         .metric-section:last-child {
             border-bottom: none;
         }

         .metric-section.total {
             margin-top: 8px;
             padding-top: 12px;
             border-top: 2px solid var(--color-primary);
             background-color: #fff;
             border-radius: 4px;
             padding: 8px;
             font-weight: 600;
         }

         .section-label {
             font-size: 12px;
             font-weight: 500;
             color: #64748b;
         }

         .metric-value {
             font-size: 13px;
             font-weight: 600;
             color: #334155;
         }

         .metric-section.total .section-label {
             color: var(--color-primary);
         }

         .metric-section.total .metric-value {
             color: var(--color-primary);
             font-size: 14px;
         }

         /* Estilos para notificaciones */
         .notification-status {
             display: flex;
             align-items: center;
             gap: 10px;
             padding: 10px 0;
             border-bottom: 1px solid #e2e8f0;
             margin-bottom: 10px;
         }

         .status-indicator {
             font-size: 12px;
         }

         .status-indicator.online {
             color: #10b981;
         }

         .status-indicator.offline {
             color: #ef4444;
         }

         .btn-activate {
             background-color: var(--color-primary);
             color: white;
             border: none;
             padding: 6px 12px;
             border-radius: 4px;
             font-size: 12px;
             font-weight: 500;
             cursor: pointer;
             transition: background-color 0.3s ease;
         }

         .btn-activate:hover {
             background-color: #e53e3e;
         }

         .btn-activate:disabled {
             background-color: #94a3b8;
             cursor: not-allowed;
         }

         .btn-test {
             background-color: #3b82f6;
             color: white;
             border: none;
             padding: 6px 12px;
             border-radius: 4px;
             font-size: 12px;
             font-weight: 500;
             cursor: pointer;
             transition: background-color 0.3s ease;
             display: flex;
             align-items: center;
             gap: 4px;
         }

         .btn-test:hover {
             background-color: #2563eb;
         }

         .btn-test:disabled {
             background-color: #94a3b8;
             cursor: not-allowed;
         }

         .config-toggle {
             background: none;
             border: none;
             font-size: 16px;
             cursor: pointer;
             padding: 4px;
             border-radius: 4px;
             transition: background-color 0.3s ease;
         }

         .config-toggle:hover {
             background-color: #f1f5f9;
         }

         .notification-config {
             animation: slideDown 0.3s ease-out;
         }

         @keyframes slideDown {
             from {
                 opacity: 0;
                 max-height: 0;
             }
             to {
                 opacity: 1;
                 max-height: 200px;
             }
         }

         .config-item {
             margin-bottom: 8px;
         }

         .config-item label {
             display: flex;
             align-items: center;
             gap: 8px;
             font-size: 12px;
             font-weight: 500;
             color: #475569;
             cursor: pointer;
         }

         .config-item input[type="checkbox"] {
             accent-color: var(--color-primary);
         }

         @media (max-width: 768px) {
             .tabs-header {
                 flex-direction: column;
             }
             
             .tab-button {
                 border-bottom: 1px solid #e2e8f0;
             }
             
             .tab-button:last-child {
                 border-bottom: none;
             }

             .metric-section {
                 flex-direction: column;
                 align-items: flex-start;
                 gap: 4px;
             }

             .notification-status {
                 flex-wrap: wrap;
                 gap: 6px;
             }

             .btn-activate, .btn-test {
                 flex: 1;
                 min-width: 80px;
             }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-title">
                <div class="logo">
                   <img src="./IMSA_Logo1-01 (1) (2).png" alt="" srcset="">
                </div>
                <div class="title">
                    <h1>ESTUDIO DE UTILIZACI√ìN DE RECURSOS</h1>
                    <h2>Monitor de Recursos</h2>
                </div>
            </div>
            <div class="date-time">
                <div id="current-date">Fecha: <span id="today-date"></span></div>
                <div id="current-time">Hora: <span id="time"></span></div>
            </div>
        </div>

        <div class="main-content">
            <!-- Contenido superior -->
            <div class="top-content">
            <!-- Panel izquierdo - Solo Referencias -->
            <div class="left-panel">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">REFERENCIAS</div>
                    </div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color status-produciendo"></div>
                            <div class="legend-text">
                                <strong>PRODUCIENDO</strong>
                                Funcionamiento normal
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-detenido"></div>
                            <div class="legend-text">
                                <strong>DETENIDO</strong>
                                Fin de operaci√≥n, corte de hilo, falta de trabajo, problema t√©c.
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-mantenimiento"></div>
                            <div class="legend-text">
                                <strong>MANTENIMIENTO</strong>
                                Mant. El√©ctrico, Mec√°nico, Limpieza
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-set-up"></div>
                            <div class="legend-text">
                                <strong>SET UP</strong>
                                Cambio de medida, cambio de carrete, color, autocontrol
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-falta-materiales"></div>
                            <div class="legend-text">
                                <strong>MATERIALES</strong>
                                Falta de materia prima, falta de materiales, cuerda, etc.
                            </div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color status-sin-operario"></div>
                            <div class="legend-text">
                                <strong>SIN OPERARIO</strong>
                                Sin operario en el recurso
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Panel derecho - Sistema de pesta√±as -->
            <div class="right-panel">
                <div class="section">
                    <div class="section-header">
                            <div class="section-title">
                                MONITOR DE RECURSOS
                                <span class="connection-status offline" id="connection-status">Desconectado</span>
                            </div>
                        <div class="section-date" id="update-time">√öltima actualizaci√≥n: <span id="last-update"></span></div>
                    </div>
                        
                        <div class="tabs-container">
                            <div class="tabs-header">
                                <button class="tab-button active" data-section="1">CABLES - SECCI√ìN 1</button>
                                <button class="tab-button" data-section="2">CABLES - SECCI√ìN 2</button>
                                <button class="tab-button" data-section="3">CABLES - SECCI√ìN 3</button>
                        </div>
                            
                            <div class="tab-content active" id="seccion-1">
                                <div class="section-stats" id="stats-1"></div>
                                <div class="grid-container" id="recursos-container-1">
                                    <div class="loading-message">
                                        <p>Cargando recursos de Secci√≥n 1...</p>
                        </div>
                        </div>
                        </div>
                            
                            <div class="tab-content" id="seccion-2">
                                <div class="section-stats" id="stats-2"></div>
                                <div class="grid-container" id="recursos-container-2">
                                    <div class="loading-message">
                                        <p>Cargando recursos de Secci√≥n 2...</p>
                        </div>
                        </div>
                        </div>
                            
                            <div class="tab-content" id="seccion-3">
                                <div class="section-stats" id="stats-3"></div>
                                <div class="grid-container" id="recursos-container-3">
                                    <div class="loading-message">
                                        <p>Cargando recursos de Secci√≥n 3...</p>
                        </div>
                        </div>
                        </div>
                        </div>
                        </div>
                        </div>
                        </div>

            <!-- Contenido inferior - M√©tricas y Notificaciones -->
            <div class="bottom-content">
                <!-- M√©tricas principales -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">M√âTRICAS PRINCIPALES</div>
                        </div>
                    <div class="metrics-container">
                        <div class="metric-card">
                            <div class="metric-title">TN Objetivo / Actual (Remitido)</div>
                            <div class="metric-sections">
                                <div class="metric-section">
                                    <span class="section-label">Secci√≥n 1:</span>
                                    <span class="metric-value" id="tn-seccion-1">
                                        <span id="tn-objetivo-1">0</span> / <span id="tn-actual-1">0</span> Kg
                                    </span>
                        </div>
                                <div class="metric-section">
                                    <span class="section-label">Secci√≥n 2:</span>
                                    <span class="metric-value" id="tn-seccion-2">
                                        <span id="tn-objetivo-2">0</span> / <span id="tn-actual-2">0</span> Kg
                                    </span>
                        </div>
                                <div class="metric-section">
                                    <span class="section-label">Secci√≥n 3:</span>
                                    <span class="metric-value" id="tn-seccion-3">
                                        <span id="tn-objetivo-3">0</span> / <span id="tn-actual-3">0</span> Kg
                                    </span>
                        </div>
                        </div>
                    </div>
                        
                        <div class="metric-card">
                            <div class="metric-title">Tiempo Total de Interrupciones</div>
                            <div class="metric-subtitle">(Sector Cables)</div>
                            <div class="metric-sections">
                                <div class="metric-section">
                                    <span class="section-label">Secci√≥n 1:</span>
                                    <span class="metric-value" id="interrupciones-1">0.0 hrs</span>
                </div>
                                <div class="metric-section">
                                    <span class="section-label">Secci√≥n 2:</span>
                                    <span class="metric-value" id="interrupciones-2">0.0 hrs</span>
            </div>
                                <div class="metric-section">
                                    <span class="section-label">Secci√≥n 3:</span>
                                    <span class="metric-value" id="interrupciones-3">0.0 hrs</span>
                                </div>
                                <div class="metric-section total">
                                    <span class="section-label">Total General:</span>
                                    <span class="metric-value" id="interrupciones-total">0.0 hrs</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuraci√≥n de Notificaciones -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">NOTIFICACIONES</div>
                        <button class="config-toggle" id="toggle-notifications">‚öôÔ∏è</button>
                    </div>
                    <div class="notification-status" id="notification-status">
                        <span class="status-indicator offline" id="status-indicator">‚ö´</span>
                        <span id="status-text">Desactivadas</span>
                        <button class="btn-activate" id="btn-activate-notifications">Activar</button>
                        <button class="btn-test" id="btn-test-notification">üîî Prueba</button>
                    </div>
                    <div class="notification-config" id="notification-config" style="display: none;">
                        <div class="config-item">
                            <label>
                                <input type="checkbox" id="alert-detenido" checked>
                                M√°quina detenida > 30 min
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                <input type="checkbox" id="alert-sin-operario" checked>
                                Sin operario > 15 min
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                <input type="checkbox" id="alert-mantenimiento">
                                Mantenimiento > 2 horas
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                <input type="checkbox" id="alert-objetivo">
                                Objetivo no cumplido (cada hora)
                            </label>
                        </div>
                        <div class="config-item">
                            <label>
                                <input type="checkbox" id="alert-sound" checked>
                                Sonido en notificaciones
                            </label>
                        </div>
                    </div>
                                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN PARA VERCEL CON PROXY =====
        
        // URL relativa - Las peticiones ser√°n redirigidas por Vercel al servidor ngrok
        const API_BASE_URL = '';
        
        let recursos = [];
        let lastUpdateTime = null;
        let isConnected = false;
        let recursosPorSeccion = {
            1: [],
            2: [],
            3: []
        };
        let currentSection = 1;
        let objetivosPorSeccion = {
            1: 0,
            2: 0,
            3: 0
        };
        
        // Variables para notificaciones
        let notificationsEnabled = false;
        let serviceWorkerRegistration = null;
        let alertHistory = new Map(); // Para evitar spam de notificaciones
        let notificationConfig = {
            detenido: true,
            sinOperario: true,
            mantenimiento: false,
            objetivo: false,
            sound: true
        };

        // Funci√≥n para hacer peticiones al servidor ngrok
        async function fetchFromAPI(endpoint, options = {}) {
            const url = `${API_BASE_URL}${endpoint}`;
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true', // Evitar warning de ngrok
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Error en ${endpoint}:`, error);
                throw error;
            }
        }

        // Actualizar fecha y hora
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            
            document.getElementById('today-date').textContent = now.toLocaleDateString('es-ES', dateOptions);
            document.getElementById('time').textContent = now.toLocaleTimeString('es-ES', timeOptions);
            
            if (lastUpdateTime) {
                document.getElementById('last-update').textContent = lastUpdateTime.toLocaleTimeString('es-ES', timeOptions);
            }
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            isConnected = connected;
            
            if (connected) {
                statusElement.textContent = 'Conectado';
                statusElement.className = 'connection-status online';
            } else {
                statusElement.textContent = 'Desconectado';
                statusElement.className = 'connection-status offline';
            }
        }

        // Convertir minutos a formato "X h Y min"
        function formatearTiempo(minutos) {
            if (!minutos || minutos === 0) {
                return "0 min";
            }
            
            const horas = Math.floor(minutos / 60);
            const minutosRestantes = minutos % 60;
            
            if (horas === 0) {
                return `${minutosRestantes} min`;
            } else if (minutosRestantes === 0) {
                return `${horas} h`;
            } else {
                return `${horas} h ${minutosRestantes} min`;
            }
        }

        // Crear elemento HTML para un recurso
        function createResourceElement(recurso) {
            const div = document.createElement('div');
            div.className = `resource-box ${recurso.estado}`;
            
            // Agregar informaci√≥n del motivo de interrupci√≥n si est√° disponible
            const motivoInfo = recurso.motivoInterrupcion ? ` - ${recurso.motivoInterrupcion}` : '';
            const tiempoFormateado = formatearTiempo(recurso.minutosEstadoActual);
            
            div.innerHTML = `
                <div class="resource-number">${recurso.numero}</div>
                <div class="resource-product">${recurso.producto}</div>
                <div class="resource-time">Tiempo: ${tiempoFormateado}</div>
                <div class="resource-info">OP: ${recurso.opEnCurso}</div>
                <div class="resource-op">Legajo: ${recurso.operarios}</div>
                <div class="resource-operator">OP Plan: ${recurso.opPendientes}</div>
            `;
            
            // Agregar t√≠tulo con informaci√≥n adicional
            div.title = `Estado: ${recurso.estadoTexto}${motivoInfo}
Kg Acumulados: ${recurso.kgAcumulados}
Tiempo en estado actual: ${tiempoFormateado}
Minutos de interrupci√≥n: ${recurso.minutosInterrupcion}`;
            
            return div;
        }

        // Cargar recursos desde la API (modificado para usar ngrok)
        async function loadRecursos() {
            try {
                const data = await fetchFromAPI('/api/recursos');
                
                if (data.success) {
                    recursos = data.data;
                    lastUpdateTime = new Date(data.timestamp);
                    updateConnectionStatus(true);
                    renderRecursos();
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (error) {
                console.error('Error al cargar recursos:', error);
                updateConnectionStatus(false);
                showError(`Error al cargar datos: ${error.message}`);
            }
        }

        // Agrupar recursos por secci√≥n
        function agruparRecursosPorSeccion() {
            recursosPorSeccion = {
                1: [],
                2: [],
                3: []
            };
            
            recursos.forEach(recurso => {
                const primerDigito = parseInt(recurso.numero.toString().charAt(0));
                if (primerDigito >= 1 && primerDigito <= 3) {
                    recursosPorSeccion[primerDigito].push(recurso);
                }
            });
        }

        // Calcular estad√≠sticas por secci√≥n
        function calcularEstadisticasSeccion(seccion) {
            const recursosSeccion = recursosPorSeccion[seccion];
            const stats = {
                total: recursosSeccion.length,
                produciendo: 0,
                detenido: 0,
                mantenimiento: 0,
                otros: 0
            };
            
            recursosSeccion.forEach(recurso => {
                switch (recurso.estado) {
                    case 'status-produciendo':
                        stats.produciendo++;
                        break;
                    case 'status-detenido':
                        stats.detenido++;
                        break;
                    case 'status-mantenimiento':
                        stats.mantenimiento++;
                        break;
                    default:
                        stats.otros++;
                        break;
                }
            });
            
            return stats;
        }

        // Renderizar estad√≠sticas de secci√≥n
        function renderEstadisticasSeccion(seccion) {
            const stats = calcularEstadisticasSeccion(seccion);
            const statsContainer = document.getElementById(`stats-${seccion}`);
            
            if (stats.total === 0) {
                statsContainer.innerHTML = '<div class="stat-item">No hay recursos en esta secci√≥n</div>';
                return;
            }
            
            statsContainer.innerHTML = `
                <div class="stat-item">Total: ${stats.total}</div>
                <div class="stat-item produciendo">Produciendo: ${stats.produciendo}</div>
                <div class="stat-item detenido">Detenidos: ${stats.detenido}</div>
                <div class="stat-item mantenimiento">Mantenimiento: ${stats.mantenimiento}</div>
                <div class="stat-item otros">Otros: ${stats.otros}</div>
            `;
        }

        // Renderizar recursos por secci√≥n
        function renderRecursosSeccion(seccion) {
            const container = document.getElementById(`recursos-container-${seccion}`);
            const recursosSeccion = recursosPorSeccion[seccion];
            
            if (recursosSeccion.length === 0) {
                container.innerHTML = '<div class="loading-message"><p>No hay recursos en esta secci√≥n</p></div>';
                return;
            }
            
            container.innerHTML = '';
            recursosSeccion.forEach(recurso => {
                const resourceElement = createResourceElement(recurso);
                container.appendChild(resourceElement);
            });
        }

        // Calcular m√©tricas por secci√≥n
        function calcularMetricasSeccion(seccion) {
            const recursosSeccion = recursosPorSeccion[seccion];
            
            let totalKgActual = 0;
            let totalMinutosInterrupcion = 0;
            
            recursosSeccion.forEach(recurso => {
                totalKgActual += recurso.kgAcumulados || 0;
                totalMinutosInterrupcion += recurso.minutosInterrupcion || 0;
            });
            
            const horasInterrupcion = totalMinutosInterrupcion / 60;
            
            return {
                kgActual: totalKgActual,
                kgObjetivo: objetivosPorSeccion[seccion] || 0,
                horasInterrupcion: horasInterrupcion
            };
        }

        // Actualizar m√©tricas en el panel izquierdo
        function actualizarMetricas() {
            let totalInterrupcionesGeneral = 0;
            
            for (let seccion = 1; seccion <= 3; seccion++) {
                const metricas = calcularMetricasSeccion(seccion);
                
                // Actualizar TN Objetivo/Actual
                document.getElementById(`tn-objetivo-${seccion}`).textContent = metricas.kgObjetivo.toLocaleString();
                document.getElementById(`tn-actual-${seccion}`).textContent = metricas.kgActual.toLocaleString();
                
                // Actualizar tiempo de interrupciones
                document.getElementById(`interrupciones-${seccion}`).textContent = 
                    `${metricas.horasInterrupcion.toFixed(1)} hrs`;
                
                totalInterrupcionesGeneral += metricas.horasInterrupcion;
            }
            
            // Actualizar total general de interrupciones
            document.getElementById('interrupciones-total').textContent = 
                `${totalInterrupcionesGeneral.toFixed(1)} hrs`;
        }

        // Cargar objetivos desde la API (modificado para usar ngrok)
        async function loadObjetivos() {
            try {
                const data = await fetchFromAPI('/api/objetivos');
                
                if (data.success) {
                    objetivosPorSeccion = data.data;
                    actualizarMetricas();
                }
            } catch (error) {
                console.error('Error al cargar objetivos:', error);
                // Usar valores por defecto si no se pueden cargar
                objetivosPorSeccion = { 1: 1200, 2: 1200, 3: 800 };
            }
        }

        // Renderizar todos los recursos
        function renderRecursos() {
            agruparRecursosPorSeccion();
            
            // Renderizar cada secci√≥n
            for (let seccion = 1; seccion <= 3; seccion++) {
                renderEstadisticasSeccion(seccion);
                renderRecursosSeccion(seccion);
            }
            
            // Actualizar m√©tricas
            actualizarMetricas();
            
            // Verificar alertas
            checkAlerts();
        }

        // Mostrar mensaje de error
        function showError(message) {
            for (let seccion = 1; seccion <= 3; seccion++) {
                const container = document.getElementById(`recursos-container-${seccion}`);
                container.innerHTML = `
                    <div class="error-message">
                        <p><strong>Error de conexi√≥n</strong></p>
                        <p>${message}</p>
                        <p>Verifica que la URL de ngrok sea correcta: ${API_BASE_URL}</p>
                    </div>
                `;
            }
        }

        // Manejar cambio de pesta√±as
        function cambiarPestana(seccion) {
            // Remover clase active de todos los botones y contenidos
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Agregar clase active al bot√≥n y contenido seleccionado
            document.querySelector(`[data-section="${seccion}"]`).classList.add('active');
            document.getElementById(`seccion-${seccion}`).classList.add('active');
            
            currentSection = seccion;
        }

        // Configurar eventos de pesta√±as
        function configurarEventosPestanas() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const seccion = parseInt(e.target.getAttribute('data-section'));
                    cambiarPestana(seccion);
                });
            });
        }

        // Inicializar Service Worker
        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    serviceWorkerRegistration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registrado exitosamente');
                } catch (error) {
                    console.error('Error al registrar Service Worker:', error);
                }
            }
        }

        // Solicitar permisos de notificaci√≥n
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('Este navegador no soporta notificaciones');
                return false;
            }

            let permission = Notification.permission;

            if (permission === 'default') {
                permission = await Notification.requestPermission();
            }

            return permission === 'granted';
        }

        // Actualizar estado de notificaciones en UI
        function updateNotificationStatus(enabled) {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const btnActivate = document.getElementById('btn-activate-notifications');

            notificationsEnabled = enabled;

            if (enabled) {
                statusIndicator.textContent = 'üü¢';
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'Activadas';
                btnActivate.textContent = 'Desactivar';
                btnActivate.style.backgroundColor = '#ef4444';
            } else {
                statusIndicator.textContent = '‚ö´';
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Desactivadas';
                btnActivate.textContent = 'Activar';
                btnActivate.style.backgroundColor = '';
            }
        }

        // Enviar notificaci√≥n
        function sendNotification(title, body, tag, requireInteraction = false) {
            if (!notificationsEnabled || !serviceWorkerRegistration) {
                return;
            }

            // Evitar spam de la misma notificaci√≥n
            const now = Date.now();
            const lastSent = alertHistory.get(tag) || 0;
            if (now - lastSent < 300000) { // 5 minutos m√≠nimo entre misma alerta
                return;
            }

            alertHistory.set(tag, now);

            // Enviar mensaje al service worker
            if (serviceWorkerRegistration.active) {
                serviceWorkerRegistration.active.postMessage({
                    type: 'SHOW_NOTIFICATION',
                    title,
                    body,
                    tag,
                    requireInteraction
                });
            }
        }

        // Verificar alertas en los recursos
        function checkAlerts() {
            if (!notificationsEnabled) return;

            recursos.forEach(recurso => {
                const minutosEstado = recurso.minutosEstadoActual || 0;
                const tag = `recurso-${recurso.numero}`;

                // Alerta: M√°quina detenida > 30 min
                if (notificationConfig.detenido && 
                    recurso.estado === 'status-detenido' && 
                    minutosEstado > 30) {
                    sendNotification(
                        '‚ö†Ô∏è M√°quina Detenida',
                        `Recurso ${recurso.numero} lleva ${formatearTiempo(minutosEstado)} detenido`,
                        `${tag}-detenido`,
                        true
                    );
                }

                // Alerta: Sin operario > 15 min
                if (notificationConfig.sinOperario && 
                    recurso.estado === 'status-sin-operario' && 
                    minutosEstado > 15) {
                    sendNotification(
                        'üë§ Sin Operario',
                        `Recurso ${recurso.numero} sin operario por ${formatearTiempo(minutosEstado)}`,
                        `${tag}-operario`
                    );
                }

                // Alerta: Mantenimiento > 2 horas
                if (notificationConfig.mantenimiento && 
                    recurso.estado === 'status-mantenimiento' && 
                    minutosEstado > 120) {
                    sendNotification(
                        'üîß Mantenimiento Prolongado',
                        `Recurso ${recurso.numero} en mantenimiento por ${formatearTiempo(minutosEstado)}`,
                        `${tag}-mantenimiento`
                    );
                }
            });

            // Alerta: Objetivos no cumplidos (cada hora)
            if (notificationConfig.objetivo) {
                checkObjetivosAlert();
            }
        }

        // Verificar alertas de objetivos
        function checkObjetivosAlert() {
            const now = new Date();
            const hour = now.getHours();
            
            // Solo verificar en horas laborales
            if (hour >= 6 && hour <= 22) {
                for (let seccion = 1; seccion <= 3; seccion++) {
                    const metricas = calcularMetricasSeccion(seccion);
                    const porcentaje = (metricas.kgActual / metricas.kgObjetivo) * 100;
                    
                    if (porcentaje < 70) { // Menos del 70% del objetivo
                        sendNotification(
                            'üìä Objetivo en Riesgo',
                            `Secci√≥n ${seccion}: ${porcentaje.toFixed(1)}% del objetivo (${metricas.kgActual}/${metricas.kgObjetivo} Kg)`,
                            `objetivo-seccion-${seccion}`
                        );
                    }
                }
            }
        }

        // Generar notificaci√≥n de prueba
        async function sendTestNotification() {
            // Solicitar permisos si no est√°n concedidos
            const granted = await requestNotificationPermission();
            if (!granted) {
                alert('‚ùå Permisos de notificaci√≥n denegados. Por favor, act√≠valos en la configuraci√≥n del navegador.');
                return;
            }

            // Array de notificaciones de ejemplo
            const testNotifications = [
                {
                    title: '‚ö†Ô∏è M√°quina Detenida',
                    body: 'Recurso 108 lleva 2 h 7 min detenido - Motivo: Problema t√©cnico',
                    tag: 'test-detenido',
                    requireInteraction: true
                },
                {
                    title: 'üë§ Sin Operario',
                    body: 'Recurso 203 sin operario asignado por 25 min',
                    tag: 'test-operario',
                    requireInteraction: false
                },
                {
                    title: 'üîß Mantenimiento Prolongado',
                    body: 'Recurso 305 en mantenimiento por 3 h 15 min - Revisi√≥n mec√°nica',
                    tag: 'test-mantenimiento',
                    requireInteraction: false
                },
                {
                    title: 'üìä Objetivo en Riesgo',
                    body: 'Secci√≥n 2: 68.5% del objetivo alcanzado (822/1200 Kg)',
                    tag: 'test-objetivo',
                    requireInteraction: false
                }
            ];

            // Seleccionar una notificaci√≥n aleatoria
            const randomNotification = testNotifications[Math.floor(Math.random() * testNotifications.length)];
            
            // Si no hay service worker a√∫n, usar notificaci√≥n simple
            if (!serviceWorkerRegistration || !serviceWorkerRegistration.active) {
                new Notification(randomNotification.title, {
                    body: randomNotification.body,
                    icon: '/IMSA_Logo1-01 (1) (2).png',
                    badge: '/IMSA_Logo1-01 (1) (2).png',
                    tag: randomNotification.tag,
                    requireInteraction: randomNotification.requireInteraction,
                    silent: !notificationConfig.sound,
                    vibrate: [200, 100, 200]
                });
            } else {
                // Usar service worker para notificaci√≥n avanzada
                serviceWorkerRegistration.active.postMessage({
                    type: 'SHOW_NOTIFICATION',
                    title: randomNotification.title,
                    body: randomNotification.body,
                    tag: randomNotification.tag,
                    requireInteraction: randomNotification.requireInteraction
                });
            }
        }

        // Configurar eventos de notificaciones
        function configurarEventosNotificaciones() {
            // Bot√≥n activar/desactivar
            document.getElementById('btn-activate-notifications').addEventListener('click', async () => {
                if (!notificationsEnabled) {
                    const granted = await requestNotificationPermission();
                    if (granted) {
                        updateNotificationStatus(true);
                        // Notificaci√≥n de activaci√≥n
                        sendNotification(
                            '‚úÖ Notificaciones Activadas',
                            'Sistema de alertas habilitado. Recibir√°s notificaciones del estado de los recursos.',
                            'activation-notification'
                        );
                    }
                } else {
                    updateNotificationStatus(false);
                }
            });

            // Bot√≥n de prueba
            document.getElementById('btn-test-notification').addEventListener('click', sendTestNotification);

            // Toggle configuraci√≥n
            document.getElementById('toggle-notifications').addEventListener('click', () => {
                const configPanel = document.getElementById('notification-config');
                if (configPanel.style.display === 'none') {
                    configPanel.style.display = 'block';
                } else {
                    configPanel.style.display = 'none';
                }
            });

            // Checkboxes de configuraci√≥n
            document.getElementById('alert-detenido').addEventListener('change', (e) => {
                notificationConfig.detenido = e.target.checked;
            });
            
            document.getElementById('alert-sin-operario').addEventListener('change', (e) => {
                notificationConfig.sinOperario = e.target.checked;
            });
            
            document.getElementById('alert-mantenimiento').addEventListener('change', (e) => {
                notificationConfig.mantenimiento = e.target.checked;
            });
            
            document.getElementById('alert-objetivo').addEventListener('change', (e) => {
                notificationConfig.objetivo = e.target.checked;
            });
            
            document.getElementById('alert-sound').addEventListener('change', (e) => {
                notificationConfig.sound = e.target.checked;
            });
        }
        
        // Efecto de parpadeo para m√°quinas detenidas
        function blinkStoppedMachines() {
            const stoppedMachines = document.querySelectorAll('.status-detenido');
            stoppedMachines.forEach(machine => {
                machine.style.opacity = machine.style.opacity === '0.7' ? '1' : '0.7';
            });
        }
        
        // Probar conexi√≥n inicial (modificado para usar ngrok)
        async function testConnection() {
            try {
                const data = await fetchFromAPI('/api/test-connection');
                updateConnectionStatus(data.success);
                return data.success;
            } catch (error) {
                updateConnectionStatus(false);
                return false;
            }
        }

        // Inicializar aplicaci√≥n (modificado para mostrar configuraci√≥n)
        document.addEventListener('DOMContentLoaded', async function() {
            // Mostrar configuraci√≥n de API
            console.log('üåç Configuraci√≥n de API:', {
                baseURL: API_BASE_URL,
                endpoints: [
                    `${API_BASE_URL}/api/recursos`,
                    `${API_BASE_URL}/api/objetivos`,
                    `${API_BASE_URL}/api/test-connection`
                ]
            });
            
            updateDateTime();
            configurarEventosPestanas();
            configurarEventosNotificaciones();
            
            // Inicializar Service Worker
            await initServiceWorker();
            
            // Probar conexi√≥n y cargar datos iniciales
            const connected = await testConnection();
            if (connected) {
                await loadObjetivos(); // Cargar objetivos primero
                await loadRecursos();  // Luego cargar recursos
            } else {
                showError('No se pudo conectar con el servidor. Verifica la URL de ngrok.');
            }
            
            // Configurar intervalos
            setInterval(updateDateTime, 1000); // Actualizar fecha/hora cada segundo
            setInterval(blinkStoppedMachines, 1000); // Efecto de parpadeo
            setInterval(loadRecursos, 30000); // Actualizar datos cada 30 segundos
            setInterval(loadObjetivos, 300000); // Actualizar objetivos cada 5 minutos
        });

        // Manejar errores de conexi√≥n
        window.addEventListener('offline', () => updateConnectionStatus(false));
        window.addEventListener('online', () => testConnection());
    </script>
</body>
</html>
        <div class="header">
            <div class="logo-title">
                <div class="logo">
                    <img src="logo.png" alt="Logo">
                </div>
                <div class="title">
                    <h1>Monitor de Recursos</h1>
                    <h2>I.M.S.A.</h2>
                </div>
            </div>
            <div class="date-time">
                <span id="date">Fecha</span>
                <span id="time">Tiempo</span>
            </div>
        </div>
        <div class="main-content">
            <div class="top-content">
                <div class="left-panel">
                    <!-- Contenido de la izquierda -->
                </div>
                <div class="right-panel">
                    <!-- Contenido de la derecha -->
                </div>
            </div>
            <div class="bottom-content">
                <!-- Contenido de la parte inferior -->
            </div>
        </div>
    </div>
    <script>
        // JavaScript para actualizar la fecha y el tiempo
        function updateDateTime() {
            const dateElement = document.getElementById('date');
            const timeElement = document.getElementById('time');
            const now = new Date();
            dateElement.textContent = now.toLocaleDateString();
            timeElement.textContent = now.toLocaleTimeString();
        }

        // Actualizar la fecha y el tiempo cada segundo
        setInterval(updateDateTime, 1000);
    </script>
</body>
</html> 